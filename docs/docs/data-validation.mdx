---
id: data-validation
title: 6. 数据校验
sidebar_label: 6. 数据校验
---

## 6.1 关于数据校验

数据校验字面上的意思就是对使用者提交过来的数据进行合法性验证。在一套完善的应用系统中，数据有效性校验是必不可少的业务处理第一道关卡。

## 6.2 数据校验的好处

- 过滤不安全数据，提高系统的安全性
- 减少不必要的业务异常处理，提高系统的响应速度
- 大大提高系统稳定性
- 大数据并发时起着一定的缓冲作用

## 6.3 数据校验方式

- 传统方式，在业务代码之前手动验证
- `Mvc` 特性方式，`Mvc` 内置的 `DataAnnotations` 方式
- **推荐方式**，`Fur` 框架内置的 `DataValidation` 验证
- 其他方式，使用第三方验证库，如 `FluentValidation`

### 6.3.1 传统方式

在很多老项目中，我们经常看到这样的代码：

```cs {4,9,14}
public bool Insert(Person person)
{
    // 验证参数
    if(string.IsNullOrEmty(person.Name))
    {
        throw new System.Exception("名字不能为空");
    }

    if(person.Age < 18)
    {
        throw new System.Exception("年龄不能小于 18 岁");
    }

    if(!person.Password.Equals(person.ConfirmPassword)
    {
        throw new System.Exception("两次密码不一致");
    }

    // 业务代码
    _repository.Insert(person.Adapt<PersonEntity>());

    // ...
}
```

从上面的代码看起来，似乎没有什么不妥，但是从一个程序可维护性来说，这是一个糟糕的代码，因为该业务代码中**包含了太多与业务无关的数据验证**。

试想一下，如果这个 `Person` 有 几十个参数都需要验证呢？可想而知，这是一个庞大的业务代码。

再者，如果其他地方也需要用到这个 `Person` 类验证呢？那代码好比老鼠啃过的面包屑一样，到处都是。

如此得知，这样的方式是极其不推荐的，**不但污染了业务代码，也破坏了业务职责单一性原理，也让验证逻辑无法实现通用，后续维护难度大大升级**。

### 6.3.2 `Mvc` 特性方式

在 `ASP.NET Core` 中，微软为我们提供了全新的 `特性` 验证方式，可通过对对象贴特性实现数据验证。这种方式有效的将数据校验和业务代码剥离开来，而且容易使用和拓展。

- **在模型中验证**

```cs {1,7-8,11-12}
using System.ComponentModel.DataAnnotations;

namespace Hoa.Application.Authorization.Dtos
{
    public class SignInInput
    {
        [Required]  // 必填验证
        [MinLength(4)]  // 最小长度验证
        public string Account { get; set; }

        [Required]    // 必填验证
        [MaxLength(32)]    // 最大长度验证
        public string Password { get; set; }
    }
}
```

- **在参数中验证**

```cs {2-3,8-9,12-13}
public void CheckMethodParameterVaild(
    [Required]    // 必填验证
    [MinLength(4)]    // 最小长度验证
    string name,

    int age,

    [Required]    // 必填验证
    [RegularExpression("[a-zA-Z0-9_]{8,30}")    // 正则表达式验证
    string password,

    [Required]    // 必填验证
    [RegularExpression("[a-zA-Z0-9_]{8,30}")    // 正则表达式验证
    string confirmPassword
)
{
    // TODO
}
```

:::note 小提醒

如果函数的参数大于或等于 3 个，建议抽离出模型类，也就是不建议上面的方式。

:::

- **自定义特性验证**

```cs {1,13-24}
public class ClassicMovieAttribute : ValidationAttribute
{
    public ClassicMovieAttribute(int year)
    {
        Year = year;
    }

    public int Year { get; }

    public string GetErrorMessage() =>
        $"Classic movies must have a release year no later than {Year}.";

    protected override ValidationResult IsValid(object value, ValidationContext validationContext)
    {
        var movie = (Movie)validationContext.ObjectInstance;
        var releaseYear = ((DateTime)value).Year;

        if (movie.Genre == Genre.Classic && releaseYear > Year)
        {
            return new ValidationResult(GetErrorMessage());
        }

        return ValidationResult.Success;
    }
}
```

- **`IValidatableObject` 复杂验证**

```cs {1,3,10-19}
using System.Collections.Generic;

public class DtoModel : IValidatableObject
{
    [Required]
    [StringLength(100)]
    public string Title { get; set; }

    // 你的验证逻辑
    public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
    {
        if (你的逻辑代码)
        {
            yield return new ValidationResult(
                "错误消息"
                ,new[] { nameof(Title) }  // 验证失败的属性
            );
        }
    }
}
```

`Mvc` 特性方式极大的将业务逻辑和验证进行了剥离和解耦，而且还能实现自定义复杂验证。

**但是 `Mvc` 特性验证方式有几个明显的缺点**：

- 只能在 `控制器` 中的 `Action`（动作方法）中使用
- **无法在任意类、任意方法中使用**
- 内置的验证类型非常有效，且不易拓展
- 不支持验证消息后期配置

所以，`Fur` 提供了新的验证引擎 `DataValidation`，在完全兼容 `Mvc` 内置验证的同时提供了大量常见验证、复杂验证、自定义验证等能力。

## 6.4 `DataValidation` 验证

`DataValidation` 是 `Fur` 框架提供了全新的验证方式，完全兼容 `Mvc` 内置验证，并且赋予了超能。

### 6.4.1 `DataValidation` 优点

- **完全兼容 `Mvc` 内置验证引擎**
- **内置常见验证类型及可自定义验证类型功能**
- 提供全局对象拓展验证方式
- 支持验证消息后期配置，支持实时更新
- 支持在任何类，任何方法、任何位置实现手动验证、特性方式验证等
- 支持设置验证结果模型

## 6.5 `DataValidation` 使用

### 6.5.1 注册验证服务

```cs {3,15} title="Fur.Web.Entry/Startup.cs"
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.DependencyInjection;

namespace Fur.Web.Entry
{
    public class Startup
    {
        // Other Codes...

        public void ConfigureServices(IServiceCollection services)
        {
            services.AddApp();
            services.AddControllers()
                    .AddDataValidation();    // 可通过 .AddDataValidation(false) 关闭全局验证处理
        }

        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
            // Other Codes...
        }
    }
}
```

:::important 特别注意

`.AddDataValidation()` 需在 `services.AddControllers()` 之后注册。同时 `services.AddApp()` 总是最先注册。

:::

### 6.5.2 第一个例子