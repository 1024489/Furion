---
id: dynamic-api-controller
title: 3. 动态 WebAPI 控制器
sidebar_label: 3. 动态 WebAPI 控制器
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

## 3.1 什么是控制器

简单来说，控制器是一个承上启下的作用，根据用户输入，执行响应行为（动作方法），同时在行为中调用模型的业务逻辑，返回给用户结果（视图）。

import kzqUrl from "../static/img/kzq.png";

<img src={kzqUrl} />

<p></p>

在 `ASP.NET Core` 中，控制器有两种表现形式：

- `Mvc`（带视图）
- `WebAPI`（RESTful API）

<Tabs
  defaultValue="mvc"
  values={[
    { label: "Mvc 控制器", value: "mvc" },
    { label: "WebAPI 控制器", value: "webapi" },
  ]}
>
  <TabItem value="mvc">

```cs {1,5,7}
using Microsoft.AspNetCore.Mvc;

namespace Fur.Web.Entry.Controllers
{
    public class MvcController : Controller
    {
        public IActionResult Index()
        {
            return View();
        }
    }
}
```

  </TabItem>
  <TabItem value="webapi">

```cs {1,5,6,8,9}
using Microsoft.AspNetCore.Mvc;

namespace Fur.Web.Entry.Controllers
{
    [Route("api/[controller]")]
    public class WebApiController : ControllerBase
    {
        [HttpGet]
        public IActionResult Get()
        {
            return Content(nameof(Fur));
        }
    }
}
```

  </TabItem>
</Tabs>

`Mvc` 控制器和 `WebAPI` 控制器最大的区别是 `WebAPI` 控制器不带 **视图** 和通过 **请求谓词和路由地址响应行为**。

## 3.2 什么是动态 `WebAPI` 控制器

在学习动态 API 控制器之前，首先了解 `ASP.NET Core` 中 `WebAPI` 的一些约定和注意事项。

### 3.2.1 `WebAPI` 约定

在 `ASP.NET Core` 应用中，一个 `WebAPI` 控制器需遵循以下几种约定：

- 控制器类**必须继承 `ControllerBase` 或间接继承**
- 动作方法**必须贴有 `[HttpMethod]` 特性，如：`[HttpGet]`**
- 控制器或动作方法**至少有一个配置 `[Route]` 特性**
- 生成 `WebAPI` 地址时会自动去掉控制器名称 `Controller` 后缀，同时也会去掉动作方法匹配的 `HttbVerb` 谓词，如 `GET，POST，DELETE，PUT` 等
- **不支持返回非 `IEnumerable<T>` 泛型对象**
- **不支持类类型参数在 `GET，HEAD` 请求下生成 `Query` 参数**

除了上述约定外，`WebAPI` 路由地址**基本靠手工完成**，不利于书写，不利于维护，再者，在移动应用对接中难以进行多版本控制。

### 3.2.2 `.NET Core WebAPI` 缺点

通过上一章节可以看出，`ASP.NET Core` 应用实现 `WebAPI` 需要遵循很多约定，而且容易出错。

除了这些以外，`.NET Core WebAPI` 有以下缺点：

- 路由地址基本靠手工完成
- 在现在移动为王的时代，不利于进行多版本控制
- 对接 `Swagger` 文档分组比较复杂
- 实现 `Policy` 策略授权也比较复杂
- 不支持控制器热拔插插件化
- 难以实现复杂自定义的 `RESTful API` 风格

## 3.3 动态 `WebAPI` 控制器

针对以上 `ASP.NET Core` 提供的 `WebAPI` 必须遵循的约定和不可避免的缺点，`Fur` 框架创造出一种更加灵活创建 `WebAPI` 的方式。

这个方式在继承了 `ASP.NET Core WebAPI` 所有优点，同时进行了大量拓展和优化。优化后的 `WebAPI` 具有以下优点：

- 具备原有的 `ControllerBase` 所有功能
- 支持**任意公开 非静态 非抽象 非泛型类**转控制器
- 提供更加灵活方便的 `IDynamicApiController` 空接口替代 `ControllerBase` 抽象类
- 无需手动配置 `[HttpMethod]` 特性，同时支持一个动作方法多个 `HttpVerb`
- 无需手动配置 `[Route]` 特性，支持更加灵活的配置及自动路由生成
- 支持返回泛型接口，泛型类
- 和 `Swagger` 深度结合，提供极其方便的创建 `Swagger` 分组配置
- 支持 `Basic Auth，Jwt，ApiKey` 等多种权限灵活配置
- 支持控制器、动作方法**版本控制**功能
- 支持 `GET、HEAD` 请求自动转换 `类类型参数`
- 支持生成 `OAS3` 接口规范

## 3.4 动态 `WebAPI` 使用

### 3.4.1 注册动态 `WebAPI` 服务

在 `Fur` 框架中，默认未注册动态 `WebAPI` 服务，我们只需要在 `Fur.Web.Entry/Startup.cs` 中注册即可。如：

```cs {4,20-21} title="Fur.Web.Entry/Startup.cs"
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;

namespace Fur.Web.Entry
{
    public class Startup
    {
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        public IConfiguration Configuration { get; }

        public void ConfigureServices(IServiceCollection services)
        {
            services.AddApp();
            services.AddControllers()
                    .AddDynamicApiControllers();
            // Other Codes...
        }

        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
            // Other Codes...
        }
    }
}
```

:::caution 特别注意

`.AddDynamicApiControllers()` 必须在 `services.AddControllers()` 之后注册。

:::

## 3.5 第一个例子

创建一个 `FurAppService` 类继承 `IDynamicApiController` 接口，并在这个类中编写一个 `Get` 方法。

```cs {1,5,7}
using Fur.DynamicApiController;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public string Get()
        {
            return $"Hello {nameof(Fur)}";
        }
    }
}
```

如下图所示，一个 `WebAPI` 接口就这么生成了。

import dyglzUrl from "../static/img/dyglz.gif";

<img src={dyglzUrl} />

## 3.6 动态 `WebAPI` 原理解析

### 3.6.1 控制器特性提供器

`Fur` 框架会在应用启动时注册 `DynamicApiControllerFeatureProvider` 控制器特性提供器，该提供器继承自 `ControllerFeatureProvider` 类。

接着重写 `bool IsController(TypeInfo typeInfo)` 方法，用来标识控制器类型。在 `Fur` 框架中，**继承自 `ControllerBase` 类或 `IDynamicApiController` 接口都会被标记为控制器类型。**

### 3.6.2 应用模型转换器

`Fur` 框架同时在应用启动时注册 `DynamicApiControllerApplicationModelConvention` 应用模型转换器，该转换器继承自 `IApplicationModelConvention` 接口。

接着实现 `void Apply(ApplicationModel application)` 接口方法。在该方法中配置控制器名称、路由、导出可见性及动作方法名称、路由、导出可见性等。

实际上该方法做的就是按照 **[WebAPI 约定](#321-webapi-约定)** 提前帮我们配置好路由、请求谓词等信息。避免了手动配置的同时还增加了许多新特性，如**版本控制。**

## 3.7 动态 `WebAPI` 配置约定

### 3.7.1 控制器默认约定

- 生成控制器名称默认去除以 `AppServices，AppService，ApiController，Controller，Services，Service` 作为前后缀的字符串。见第一个例子中的 `FurAppService -> Fur` **支持自定义配置**
- 控制器名称带 `V[0-9_]` 结尾的，会自动生成控制器版本号，如 `FurAppServiceV2 -> Fur@2`，`FurAppServiceV1_1_0 -> Fur@1.1.0`。**支持版本分隔符配置**
- 控制名称以 `骆驼命名（CamelCase）` 会自动切割成多个单词 `-` 连接。**支持版本分隔符配置**

### 3.7.2 动作方法默认约定

- 生成的动作方法名称默认去除以 `Post/Add/Create/Insert/Submit，Get/Find/Fetch/Query/Search，Put/Update，Delete/Remove/Clear` 开头的字符串。**支持自定义配置**
- 生成的动作方法名称默认去除以 `Async` 作为前后缀的字符串。**支持自定义配置**
- 动作方法名称带 `V[0-9_]` 结尾的，会自动生成动作方法版本号，如 `ChangePasswordV2 -> ChangePassword@2`，`ChangePasswordV1_1_0 -> ChangePassword@1_1_0`。**支持版本分隔符配置**
- 动作方法名称以 `骆驼命名（CamelCase）` 会自动切割成多个单词 `-` 连接。**支持版本分隔符配置**
- 动作方法参数将自动转为小写。**支持版本分隔符配置**

### 3.7.3 请求谓词默认约定

- 动作方法名
  - 以 `Post/Add/Create/Insert/Submit` 开头，则添加 `[HttpPost]` 特性。
  - 以 `Get/Find/Fetch/Query/Search` 开头，则添加 `[HttpPost]` 特性。
  - 以 `Put/Update` 开头，则添加 `[HttpPut]` 特性。
  - 以 `Delete/Remove/Clear` 开头，则添加 `[HttpDelete]` 特性。
  - **支持自定义配置**
- 如果不在上面约定中，则默认添加 `[HttpPost]` 特性。**支持自定义配置**

### 3.7.4 路由地址默认约定

- 默认以 `api` 开头。**支持自定义配置**
- 默认转换为小写路由地址。**支持自定义配置**
- 生成控制器路由模板格式为：`api/前置参数列表/模块名或默认区域名/[controller@版本号]/后置参数列表`
- 生成动作方法路由模板格式为：`前置参数列表/模块名/[action@版本号]/后置参数列表`

### 3.7.5 其他约定

- 默认不处理 `ControllerBase` 控制器类型。**支持自定义配置**
- 默认不处理 `GET，HEAD` 请求的引用类型参数。**支持自定义配置**

## 3.8 更多例子

### 3.8.1 多种请求谓词方法

```cs {7,12,17,22}
using Fur.DynamicApiController;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public string Get()
        {
            return $"GET 请求";
        }

        public string Post()
        {
            return $"POST 请求";
        }

        public string Delete()
        {
            return $"DELETE 请求";
        }

        public string Put()
        {
            return $"PUT 请求";
        }
    }
}
```

如下图所示：

import dgqqwcUrl from "../static/img/dgqqwc.gif";

<img src={dgqqwcUrl} />

### 3.8.2 多个自定义动作方法

```cs {7,12,17}
using Fur.DynamicApiController;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public string GetVersion()
        {
            return $"v1.0.0";
        }

        public string ChangeProfile()
        {
            return "修改成功";
        }

        public string DeleteUser()
        {
            return "删除成功";
        }
    }
}
```

如下图所示：

import dzmcUrl from "../static/img/dzmc.png";

<img src={dzmcUrl} />

### 3.8.3 带参数动作方法

```cs {7,12,17}
using Fur.DynamicApiController;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public string GetUser(int id)
        {
            return $"{id}";
        }

        public string GetUser(int id, string name)
        {
            return $"{id} {name}";
        }

        public TestDto Add(TestDto testDto)
        {
            return testDto;
        }
    }
}
```

如下图所示：

import dcsffUrl from "../static/img/dcsff.gif";

<img src={dcsffUrl} />

### 3.8.5 `GET/HEAD` 类类型参数

默认情况下，`ASP.NET Core` 会将 `GET/HEAD` 请求中的 `类类型参数` 设置为 `[FromBody]` 绑定，如：

```cs {7}
using Fur.DynamicApiController;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public TestDto GetTest(TestDto testDto)
        {
            return testDto;
        }
    }
}
```

如下图所示：

import getyycsUrl from "../static/img/getyycs.png";

<img src={getyycsUrl} />

这时如果我们需要转换为 `Query` 查询参数，有以下两种方式：

<Tabs
  defaultValue="fromquery"
  values={[
    { label: "[FromQuery] 特性", value: "fromquery" },
    {
      label: "配置 DynamicApiControllerSettings",
      value: "DynamicApiControllerSettings",
    },
  ]}
>
  <TabItem value="fromquery">

```cs {2,8}
using Fur.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public TestDto GetTest([FromQuery] TestDto testDto)
        {
            return testDto;
        }
    }
}
```

  </TabItem>
  <TabItem value="DynamicApiControllerSettings">

```json {2-4} title="Fur.Web.Entry/appsettings.json"
{
  "AppSettings": {
    "DynamicApiControllerSettings": {
      "ModelToQuery": true
    }
  }
}
```

  </TabItem>
</Tabs>

如下图所示：

import modeltoqueryUrl from "../static/img/modeltoquery.png";

<img src={modeltoqueryUrl} />

### 3.8.6 自定义参数位置

`Fur` 框架提供了非常方便的自定义参数位置的特性 `[ApiSeat]`，通过 `[ApiSeat]` 可配置参数位置，支持以下四种位置：

- `ApiSeats.ControllerStart`：控制器之前
- `ApiSeats.ControllerEnd`：控制器之后
- `ApiSeats.ActionStart`：动作方法之前
- `ApiSeats.ActionEnd`：动作方法之后。**默认值**

```cs {8-9,15-20}
using Fur.DynamicApiController;
using System;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        // 参数默认为 ApiSeats.ActionEnd
        public string RouteSeat(int id, string name)
        {
            return "配置路由参数位置";
        }

        public string RouteSeat(
            [ApiSeat(ApiSeats.ControllerStart)] int id, // 控制器名称之前
            [ApiSeat(ApiSeats.ControllerEnd)] string name, // 控制器名称之后
            [ApiSeat(ApiSeats.ControllerEnd)] int age, // 控制器名称之后
            [ApiSeat(ApiSeats.ActionStart)] decimal weight, // 动作方法名称之前
            [ApiSeat(ApiSeats.ActionStart)] float height, // 动作方法名称之前
            [ApiSeat(ApiSeats.ActionEnd)] DateTime birthday) // 动作方法名称之后（默认值）
        {
            return "配置路由参数位置";
        }
    }
}
```

如下图所示：

import cswzUrl from "../static/img/cswz.png";

<img src={cswzUrl} />

:::note 温馨提示

多个 **`同位置`** 配置的参数将按照 **`定义参数顺序`** 进行排序。

:::

:::caution 特别注意

`[ApiSeat]` 只能引用于提了 `[FromRoute]` 特性的参数或 `基元类型、值类型、可空基元类型和可空值类型`。

:::

### 3.8.7 自定义请求谓词

```cs {2,8}
using Fur.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        [HttpPost]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

如下图所示：

import zdywcUrl from "../static/img/zdywc.png";

<img src={zdywcUrl} />

### 3.8.8 支持多个谓词

```cs {2,8}
using Fur.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        [HttpPost, HttpGet, AcceptVerbs("PUT", "DELETE")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

如下图所示：

import dgwcUrl from "../static/img/dgwc.png";

<img src={dgwcUrl} />

:::caution 特别注意

如果动作方法中含有 `类类型参数`，且含有 `POST/PUT/DELETE` 任意请求谓词，那么该参数会自动添加 `[FromBody]` 参数，即使在 `GET/HEAD` 请求中不支持。

:::

### 3.8.9 支持自定义路由

支持控制器和动作方法自定义路由：

import kzqrlUrl from "../static/img/kzqrl.png";
import dzffrlUrl from "../static/img/dzffrl.png";
import allrlUrl from "../static/img/allrl.png";
import wcrlUrl from "../static/img/wcrl.png";

<Tabs
  defaultValue="kzqrl"
  values={[
    { label: "自定义控制器路由", value: "kzqrl" },
    { label: "自定义动作方法路由", value: "dzffrl" },
    { label: "同时自定义路由", value: "allrl" },
    { label: "谓词自定义路由", value: "vcrl" },
  ]}
>
  <TabItem value="kzqrl">

```cs {2,6}
using Fur.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Fur.Application
{
    [Route("customapi/mobile/[controller]")]
    public class FurAppService : IDynamicApiController
    {
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

如下图所示：

<img src={kzqrlUrl} />

  </TabItem>
  <TabItem value="dzffrl">

```cs {2,8}
using Fur.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        [Route("customapi/[action]")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

如下图所示：

<img src={dzffrlUrl} />

  </TabItem>
  <TabItem value="allrl">

```cs {2,6,9}
using Fur.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Fur.Application
{
    [Route("customapi/mobile/[controller]")]
    public class FurAppService : IDynamicApiController
    {
        [Route("get/[action]")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

如下图所示：

<img src={allrlUrl} />

  </TabItem>
  <TabItem value="vcrl">

```cs {9}
using Fur.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Fur.Application
{
    [Route("api/[controller]")]
    public class FurAppService : IDynamicApiController
    {
        [HttpGet("get/[action]")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

如下图所示：

<img src={wcrlUrl} />

  </TabItem>
</Tabs>

:::important 小提示

动态方法自定义路由如果以 **`/`** 开头，则不会合并控制器路由。

:::

:::tip 推荐配置

自定义路由如果需要用到 **控制器/动作方法名称**，推荐使用 `[controller]` 或 `[action]` 占位符，因为该占位符已经自动处理了 **前后缀、版本号、模块名称**等。

:::

### 3.8.10 多路由随意组合

`Fur` 框架提供了非常灵活的各种路由组合方式，支持一对多，多对多路由组合：

```cs {6-8,11-14}
using Fur.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Fur.Application
{
    [Route("api/[controller]")]
    [Route("api/[controller]/second")]
    [Route("api/[controller]/three")]
    public class FurAppService : IDynamicApiController
    {
        [HttpGet]
        [HttpGet("get/[action]")]
        [HttpPost]
        [HttpPost("post/cus-version")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

如下图所示：

import dlrzhUrl from "../static/img/dlrzh.gif";

<img src={dlrzhUrl} />

:::caution 特别注意

动作方法不能同时贴 `[Route]` 和 `[HttpMethod]` 特性，只能二取一。

:::

### 3.8.11 支持版本控制

import kzqbbUrl from "../static/img/kzqbb.png";
import dzffbbUrl from "../static/img/dzffbb.png";

<Tabs
  defaultValue="kzqbb"
  values={[
    { label: "控制器版本", value: "kzqbb" },
    { label: "动作方法版本", value: "dzffbb" },
  ]}
>
  <TabItem value="kzqbb">

```cs {5,13,21}
using Fur.DynamicApiController;

namespace Fur.Application
{
    public class FurAppServiceV1 : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Fur);
        }
    }

    public class FurAppServiceV1_2 : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Fur);
        }
    }

    public class FurAppServiceV1_2_1 : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Fur);
        }
    }
}
```

如下图所示：

<img src={kzqbbUrl} />

  </TabItem>
  <TabItem value="dzffbb">

```cs {7,12,16}
using Fur.DynamicApiController;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Fur);
        }

        public string GetV1()
        {
            return nameof(Fur);
        }
        public string GetV2_1()
        {
            return nameof(Fur);
        }
    }
}
```

如下图所示：

<img src={dzffbbUrl} />

  </TabItem>
</Tabs>

:::tip 版本复写

除了通过特定后缀方式以外，版本还直接通过 `[ApiDescriptionSettings]` 进行复写。如：

```cs {1,2}
[ApiDescriptionSettings(Version = "3.0")]
public string GetV1()
{
    return nameof(Fur);
}
```

这时，生成版本将采用 `3.0` 替代 `1`

:::