---
id: bs-to-cs
title: 34.7 发布桌面程序（WinForm/WPF）
sidebar_label: 34.7 发布桌面程序（WinForm/WPF）
---

import useBaseUrl from "@docusaurus/useBaseUrl";

:::important 版本说明

以下内容仅限 `Furion 4.8.7.28 +` 版本使用。

:::

`Furion` 框架灵活的架构模式使得 `Web` 和各客户端（`WinForm/WPF/Console`） 项目之间迁移变得非常简单，只需要极少数修改即可实现无缝迁移。

**通过这种方式可以实现类似前端的 `Electron/Tauri` 混合式开发。**

本章节提供如何将 `Web` 项目发布（迁移）到 `WinForm/WPF` 中，同样也适合控制台应用程序。

## 34.7.1 迁移步骤

### 34.7.1.1 创建 `WinForm/WPF` 项目

通过 `Visual Studio` 创建 `WinForm/WPF` 项目，同样适合控制台项目。

### 34.7.1.2 初始化 `WinForm/WPF` 配置

- `WinForm` 初始化

```cs showLineNumbers {3,8}
namespace WinFormsApp1;

internal static class Program
{
    [STAThread]
    static void Main()
    {
        Serve.RunNative(RunOptions.Default);

        ApplicationConfiguration.Initialize();
        Application.Run(new Form1());
    }
}
```

- `WPF` 初始化

```cs showLineNumbers {3,7}
namespace WpfApp1;

public partial class App : Application
{
    public App()
    {
        Serve.RunNative(RunOptions.Default);
    }
}
```

### 34.7.1.3 添加 `YourProject.Web.Core` 层引用

```xml showLineNumbers {2}
<ItemGroup>
    <ProjectReference Include="..\Your.Web.Core\Furion.Web.Core.csproj" />
</ItemGroup>
```

### 34.7.1.4 拷贝 `YourProject.Web.Entry` 内容

如果有 `YourProject.Web.Entry` 启动层包含 `*.json` 文件、`Controllers`、`Views` 、`wwwroot` 目录则拷贝到 `WinForm/WPF` 中

<img src={useBaseUrl("img/n1.png")} />

## 34.7.2 配置 `WinForm/WPF` 项目文件

双击 `WinForm/WPF` 项目进入 `.csproj` 文件编辑。

### 34.7.2.1 修改 `Sdk` 属性

将 `Sdk="Microsoft.NET.Sdk"` 修改为 `Sdk="Microsoft.NET.Sdk.Razor"`

```xml showLineNumbers
<Project Sdk="Microsoft.NET.Sdk.Razor">
```

### 34.7.2.2 添加 `MVC/Razor` 支持

- `WinForm`

```xml showLineNumbers {1,9-11}
<Project Sdk="Microsoft.NET.Sdk.Razor">

	<PropertyGroup>
		<OutputType>WinExe</OutputType>
		<TargetFramework>net7.0-windows</TargetFramework>
		<Nullable>enable</Nullable>
		<UseWindowsForms>true</UseWindowsForms>
		<ImplicitUsings>enable</ImplicitUsings>
		<SatelliteResourceLanguages>en-US</SatelliteResourceLanguages>
		<PublishReadyToRunComposite>true</PublishReadyToRunComposite>
		<AddRazorSupportForMvc>true</AddRazorSupportForMvc>
	</PropertyGroup>

</Project>
```

- `WPF`

```xml showLineNumbers {1,9-11}
<Project Sdk="Microsoft.NET.Sdk.Razor">

	<PropertyGroup>
		<OutputType>WinExe</OutputType>
		<TargetFramework>net7.0-windows</TargetFramework>
		<Nullable>enable</Nullable>
		<ImplicitUsings>enable</ImplicitUsings>
		<UseWPF>true</UseWPF>
		<SatelliteResourceLanguages>en-US</SatelliteResourceLanguages>
		<PublishReadyToRunComposite>true</PublishReadyToRunComposite>
		<AddRazorSupportForMvc>true</AddRazorSupportForMvc>
	</PropertyGroup>

</Project>

```

### 34.7.2.3 添加 `wwwroot` 静态发布配置

如果 `YourProject.Web.Entry` 包含 `wwwroot` 目录，则添加以下配置，否则跳过。

```xml showLineNumbers
<ItemGroup>
	<Content Update="wwwroot\**\*">
		<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
	</Content>
</ItemGroup>
```

### 34.7.2.4 完整配置

完整的配置大概如下：

- `WinForm`

```xml showLineNumbers {1,9-11,14-18,20-22}
<Project Sdk="Microsoft.NET.Sdk.Razor">

	<PropertyGroup>
		<OutputType>WinExe</OutputType>
		<TargetFramework>net7.0-windows</TargetFramework>
		<Nullable>enable</Nullable>
		<UseWindowsForms>true</UseWindowsForms>
		<ImplicitUsings>enable</ImplicitUsings>
		<SatelliteResourceLanguages>en-US</SatelliteResourceLanguages>
		<PublishReadyToRunComposite>true</PublishReadyToRunComposite>
		<AddRazorSupportForMvc>true</AddRazorSupportForMvc>
	</PropertyGroup>

	<ItemGroup>
		<Content Update="wwwroot\**\*">
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</Content>
	</ItemGroup>

	<ItemGroup>
		<ProjectReference Include="..\Furion.Web.Core\Furion.Web.Core.csproj" />
	</ItemGroup>

</Project>
```

- `WPF`

```xml showLineNumbers {1,9-11,14-18,20-22}
<Project Sdk="Microsoft.NET.Sdk.Razor">

    <PropertyGroup>
        <OutputType>WinExe</OutputType>
        <TargetFramework>net7.0-windows</TargetFramework>
        <Nullable>enable</Nullable>
        <ImplicitUsings>enable</ImplicitUsings>
        <UseWPF>true</UseWPF>
        <SatelliteResourceLanguages>en-US</SatelliteResourceLanguages>
		<PublishReadyToRunComposite>true</PublishReadyToRunComposite>
        <AddRazorSupportForMvc>true</AddRazorSupportForMvc>
    </PropertyGroup>

	<ItemGroup>
		<Content Update="wwwroot\**\*">
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</Content>
	</ItemGroup>

	<ItemGroup>
		<ProjectReference Include="..\Furion.Web.Core\Furion.Web.Core.csproj" />
	</ItemGroup>

</Project>

```

## 37.7.3 嵌入 `WebView2`

我们可以在 `WinForm/WinForm` 层添加 `Microsoft.Web.WebView2` 包，然后在窗口中添加 `WebView2` 组件，实现类似前端 `Electron.js` 混合开发。

### 37.7.3.1 添加 `WebView2` 拓展

```bash showLineNumbers
dotnet add package Microsoft.Web.WebView2
```

### 37.7.3.2 添加 `WebView2` 控件并填充窗口

- `WinForm`

```cs showLineNumbers {8,10-11,14-17}
namespace WinFormsApp1;

public partial class Form1 : Form
{
    public Form1()
    {
        InitializeComponent();
        this.Resize += Form1_Resize;

        webview.Size = this.ClientSize;
        webview.Source = new Uri("http://localhost:5000/Home");
    }

    private void Form1_Resize(object? sender, EventArgs e)
    {
        webview.Size = this.ClientSize;
    }
}
```

- `WPF`

```xml
<Wpf:WebView2 Name="webview" />
```

```cs showLineNumbers {11}
using System.Windows;

namespace WpfApp1;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();

        webview.Source = new Uri("http://localhost:5000/Home");
    }
}
```

### 34.7.3.3 预览效果

<img src={useBaseUrl("img/n4.png")} />

<img src={useBaseUrl("img/n2.png")} />

<br />
<br />

相关技术文档：

- [https://learn.microsoft.com/zh-cn/microsoft-edge/webview2/get-started/winforms](https://learn.microsoft.com/zh-cn/microsoft-edge/webview2/get-started/winforms)
- [https://learn.microsoft.com/zh-cn/microsoft-edge/webview2/get-started/wpf](https://learn.microsoft.com/zh-cn/microsoft-edge/webview2/get-started/wpf)

## 34.7.4 发布 `WinForm/WPF`

### 34.7.4.1 启动层添加 `SingleFilePublish`

通常桌面软件都是发布为不依赖环境（独立发布），所以在启动层添加 `SingleFilePublish.cs` 文件编辑。

**详细教程可查看 [【34.5 单文件发布】](./singlefile.mdx)**

```cs showLineNumbers {4,6}
using Furion;
using System.Reflection;

namespace WinFormsApp1;

public class SingleFilePublish : ISingleFilePublish
{
    public Assembly[] IncludeAssemblies()
    {
        return Array.Empty<Assembly>();
    }

    public string[] IncludeAssemblyNames()
    {
        return new[]
        {
            "Furion.Application",
            "Furion.Core",
            "Furion.EntityFramework.Core",
            "Furion.Web.Core"
        };
    }
}

```

### 34.7.4.2 发布配置

发布可参考以下配置即可。

<img src={useBaseUrl("img/n5.png")} />

相关技术文档：

- [https://blog.csdn.net/xfy18317776108/article/details/122343091](https://blog.csdn.net/xfy18317776108/article/details/122343091)

## 34.7.5 反馈与建议

:::note 与我们交流

给 Furion 提 [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)。

:::
