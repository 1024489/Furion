---
id: freesql
title: 10.3. FreeSql 集成
sidebar_label: 10.3. FreeSql 集成
---

## 10.3.1 关于 FreeSql

`FreeSql` 官方地址：[https://github.com/dotnetcore/FreeSql](https://github.com/dotnetcore/FreeSql)

## 10.3.2 如何集成

在 `Furion` 框架中，已经推出 `FreeSql` 拓展包 [Furion.Extras.DatabaseAccessor.FreeSql](https://www.nuget.org/packages/Furion.Extras.DatabaseAccessor.FreeSql)。

### 10.3.2.1 注册 `FreeSql` 服务

使用非常简单，只需要在 `Startup.cs` 中添加 `services.AddFreeSql(config)` 即可。如：

```cs
services.AddFreeSql("Server=.xxxxx", DataType.Sqlite);
```

同时也可以添加更多配置，如：

```cs
services.AddFreeSql("Server=.xxxxx", DataType.Sqlite, builder => {
    builder.UseAutoSyncStructure(true);
});
```

:::important 安装拓展包位置

在 `Furion` 框架中，推荐将拓展包 `Furion.Extras.DatabaseAccessor.FreeSql` 安装到 `Furion.Core` 层中。

:::

## 10.3.3 基本使用

在使用之前，我们可以通过构造函数注入 `IFreeSqlRepository<TEntity>` 接口，如：

```cs
private readonly IFreeSqlRepository<Person> _FreeSqlRepository;
public PersonService(IFreeSqlRepository<Person> FreeSqlRepository)
{
    _FreeSqlRepository = FreeSqlRepository;
}
```

### 10.3.3.1 新增操作

```cs
_FreeSqlRepository.Insert(new Person(){ Name = "Furion" });
```

### 10.3.3.2 更新操作

```cs
_FreeSqlRepository.Update(new Person(){ Id = 1, Name = "Furion/Fur" });
```

### 10.3.3.3 删除操作

```cs
_FreeSqlRepository.Delete(1);
```

### 10.3.3.4 查询操作

```cs
var data = _FreeSqlRepository.Where(u => u.Id > 10).ToList();

var data  = _FreeSqlRepository.Where(!string.IsNullOrEmpty(name), u => u.Name.Contains(name)).ToList();
```

### 10.3.3.5 分页查询

```cs
int totalCount = 0;
var data = _FreeSqlRepository.Where(u => u.Id > 10).Count(out var total).Page(1, 20).Tolist();
```

## 10.3.4 高级使用

### 10.3.4.1 `IFreeSqlClient` 对象

```cs
var freeSqlClient = _FreeSqlRepository.Context;
```

拿到这个对象之后，就可以使用 `FreeSql` 完整的功能，比如操作链表查询

```cs
var data = freeSqlClient.Select<Topic, Category, CategoryType>()
  .LeftJoin((a,b,c) => a.CategoryId == b.Id)
  .LeftJoin((a,b,c) => b.ParentId == c.Id)
  .Where((a,b,c) => c.Id > 0)
  .ToList((a,b,c) => new { a,b,c });
```

### 10.3.4.2 `IAdo` 对象

```cs
var ado = _FreeSqlRepository.Ado;
```

拿到该对象就可以操作原生 `sql`，如：

```cs
var dt = ado.ExecuteDataTable("select * from table where id=@id and name=@name",new{id=1,name=2});
```

## 10.3.5 关于仓储

`Furion` 框架为 `FreeSql` 提供了两个仓储：

- `IFreeSqlRepository`：非泛型仓储，可以通过 `.Change<TEntity>` 方法切换到任何实体仓储
- `IFreeSqlRepository<TEntity>`：实体泛型仓储

### 10.3.5.1 选用原则

懒人可以在构造函数中注入 `IFreeSqlRepository` 仓储，不带泛型的版本，这样构造函数只会有一个仓储示例，之后通过 `.Change<TEntity>` 方法切换，如：

```cs
// 切换 Persion 仓储
var personRep = _FreeSqlRepository.Change<Persion>();
personRep.Insert(person);

// 切换其他仓储
var otherRep = _FreeSqlRepository.Change<Other>();
otherRep.Update(other);

// 也可以通过泛型仓储切换
var studentRep = personRep.Change<Student>();
```

## 10.3.6 反馈与建议

:::note 与我们交流

给 Furion 提 [Issue](https://gitee.com/monksoul/Furion/issues/new?issue)。

:::

---

:::note 了解更多

想了解更多 `FreeSql` 知识可查阅 [FreeSql 官网](https://github.com/dotnetcore/FreeSql)。

:::
